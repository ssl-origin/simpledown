<!-- INCLUDE overall_header.html -->

<h1>{L_ACP_SIMPLEDOWN_TITLE} - {L_ACP_SIMPLEDOWN_EXISTING_FILES}</h1>

<form id="acp_simpledown" method="post" action="{U_ACTION}" enctype="multipart/form-data">
    {S_FORM_TOKEN}

    <!-- ======================================== -->
    <!-- MODO EDIÇÃO DE ARQUIVO -->
    <!-- ======================================== -->
    <!-- IF S_EDIT_MODE -->
    <fieldset>
        <legend>{L_ACP_SIMPLEDOWN_EDIT_DESCRIPTION}: <strong>{EDIT_FILE_NAME}</strong></legend>

        <input type="hidden" name="action" value="edit" />
        <input type="hidden" name="id" value="{EDIT_FILE_ID}" />

        <dl>
            <dt><label for="edit_file_name">{L_ACP_SIMPLEDOWN_FILE_NAME}:</label><br />
                <span>{L_ACP_SIMPLEDOWN_FILE_NAME_EXPLAIN}</span>
            </dt>
            <dd><input type="text" id="edit_file_name" name="edit_file_name" value="{EDIT_FILE_NAME}" maxlength="255" size="50" required /></dd>
        </dl>

        <dl>
            <dt><label for="edit_file_desc_short">{L_ACP_SIMPLEDOWN_SHORT_DESCRIPTION}:</label></dt>
            <dd><textarea id="edit_file_desc_short" name="edit_file_desc_short" rows="3" cols="60">{EDIT_FILE_DESC_SHORT}</textarea></dd>
        </dl>

        <!-- TOOLBAR + DESCRIÇÃO COMPLETA COM BBCODE -->
<dl>
    <dt><label for="file_desc">{{ lang('ACP_SIMPLEDOWN_DESCRIPTION') }}:</label><br>
        <span>{{ lang('ACP_SIMPLEDOWN_DESCRIPTION_EXPLAIN') }}</span></dt>
    <dd>
        <div class="bbcode-toolbar">
            <button type="button" class="bbcode-btn" data-tag="b" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_BOLD') }}"><strong>B</strong></button>
            <button type="button" class="bbcode-btn" data-tag="i" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_ITALIC') }}"><em>I</em></button>
            <button type="button" class="bbcode-btn" data-tag="u" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_UNDERLINE') }}"><u>U</u></button>
            <button type="button" class="bbcode-btn" data-tag="quote" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_QUOTE') }}">Quote</button>
            <button type="button" class="bbcode-btn" data-tag="code" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_CODE') }}">Code</button>
            <button type="button" class="bbcode-btn" data-tag="url" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_URL') }}">URL</button>
            <button type="button" class="bbcode-btn" data-tag="img" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_IMG') }}">IMG</button>
            <button type="button" class="bbcode-btn" data-tag="list" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_LIST') }}">List</button>
            <label for="color-picker-add" class="bbcode-btn color-btn" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_COLOR') }}">
                <i class="fa-solid fa-palette"></i> {{ lang('ACP_SIMPLEDOWN_BBCODE_COLOR') }}
            </label>
            <input type="color" id="color-picker-add" style="position:absolute; left:-9999px;">
            <select class="bbcode-btn size-select" title="{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE_TITLE') }}">
                <option value="" disabled selected>{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE') }}</option>
                <option value="50">{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE_VERY_SMALL') }}</option>
                <option value="85">{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE_SMALL') }}</option>
                <option value="100">{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE_NORMAL') }}</option>
                <option value="150">{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE_LARGE') }}</option>
                <option value="200">{{ lang('ACP_SIMPLEDOWN_BBCODE_SIZE_VERY_LARGE') }}</option>
            </select>
        </div>
        <textarea id="file_desc" name="file_desc" rows="12" cols="80" class="inputbox"></textarea>
    </dd>
</dl>

        <dl>
            <dt><label for="edit_file_version">{L_ACP_SIMPLEDOWN_VERSION}:</label><br />
                <span>{L_ACP_SIMPLEDOWN_VERSION_EXPLAIN}</span>
            </dt>
            <dd><input type="text" id="edit_file_version" name="edit_file_version" value="{EDIT_FILE_VERSION}" maxlength="50" size="20" placeholder="ex: 2.1.0" /></dd>
        </dl>

        <dl>
            <dt><label for="edit_category">{L_ACP_SIMPLEDOWN_CATEGORY}:</label></dt>
            <dd>
                <select id="edit_category" name="edit_category">
                    <option value="0">{L_ACP_SIMPLEDOWN_NO_CATEGORY}</option>
                    <!-- BEGIN categories -->
                    <option value="{categories.ID}" {categories.S_SELECTED}>{categories.NAME}</option>
                    <!-- END categories -->
                </select>
            </dd>
        </dl>

        <dl>
            <dt><label>{L_ACP_SIMPLEDOWN_VISIBILITY}:</label><br />
                <span>{L_ACP_SIMPLEDOWN_VISIBILITY_EXPLAIN}</span>
            </dt>
            <dd>
                <label><input type="radio" name="is_private" value="0" id="is_private_public" <!-- IF not EDIT_FILE_IS_PRIVATE -->checked<!-- ENDIF --> /> {L_ACP_SIMPLEDOWN_PUBLIC}</label>&nbsp;&nbsp;&nbsp;
                <label><input type="radio" name="is_private" value="1" id="is_private_private" <!-- IF EDIT_FILE_IS_PRIVATE -->checked<!-- ENDIF --> /> {L_ACP_SIMPLEDOWN_PRIVATE}</label>
            </dd>
        </dl>

        <!-- Substituir arquivo -->
        <fieldset>
            <legend>{L_ACP_SIMPLEDOWN_REPLACE_FILE}</legend>
            <dl>
                <dt><label>{L_ACP_SIMPLEDOWN_REPLACE_FILE}:</label><br />
                    <span>{L_ACP_SIMPLEDOWN_REPLACE_FILE_EXPLAIN}</span>
                </dt>
                <dd>
                    <div class="custom-file-upload">
                        <input type="file" id="replace_upload" name="replace_upload" />
                        <label for="replace_upload" class="custom-file-label">
                            <span>{L_ACP_SIMPLEDOWN_CHOOSE_FILE}</span>
                        </label>
                        <span class="file-name-display" id="replace-file-name-display">{L_ACP_SIMPLEDOWN_NO_FILE_SELECTED}</span>
                    </div>

                    <!-- IF EDIT_FILE_REALNAME -->
                    <div style="margin-top: 12px; padding: 10px; background: var(--light-bg); border: 1px solid var(--border); border-radius: 8px; font-size: 0.95em;">
                        <strong>{L_ACP_SIMPLEDOWN_CURRENT_FILE}:</strong> {EDIT_FILE_REALNAME}
                    </div>
                    <!-- ENDIF -->
                </dd>
            </dl>
        </fieldset>

        <!-- Miniatura existente -->
        <dl>
            <dt><label for="existing_thumb">{L_ACP_SIMPLEDOWN_SELECT_THUMB}:</label></dt>
            <dd>
                <!-- IF S_THUMBS_EXIST -->
                <select id="existing_thumb" name="existing_thumb">
                    <option value="">{L_ACP_SIMPLEDOWN_NO_THUMB}</option>
                    <!-- BEGIN thumbs -->
                    <option value="{thumbs.FILENAME}" <!-- IF thumbs.FILENAME == EDIT_FILE_THUMBNAIL -->selected<!-- ENDIF -->>{thumbs.FILENAME}</option>
                    <!-- END thumbs -->
                </select>

                <div id="thumb-preview" style="margin-top: 15px; text-align: center; display: none;">
                    <p><strong>{L_ACP_SIMPLEDOWN_THUMB_PREVIEW}</strong></p>
                    <img id="thumb-preview-img" src="" alt="Pré-visualização da miniatura" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: var(--shadow);" />
                </div>
                <!-- ELSE -->
                <p style="color: var(--text-light);">{L_ACP_SIMPLEDOWN_NO_THUMBS}</p>
                <!-- ENDIF -->
            </dd>
        </dl>

        <!-- Upload nova miniatura -->
        <fieldset>
            <legend>{L_ACP_SIMPLEDOWN_UPLOAD_THUMB}</legend>
            <dl>
                <dt><label for="thumb_upload">{L_ACP_SIMPLEDOWN_UPLOAD_THUMB}:</label><br />
                    <span>{L_ACP_SIMPLEDOWN_UPLOAD_THUMB_EXPLAIN}</span>
                </dt>
                <dd>
                    <div class="custom-file-upload">
                        <input type="file" id="thumb_upload" name="thumb_upload" accept="image/jpeg,image/png,image/gif,image/webp" />
                        <label for="thumb_upload" class="custom-file-label">
                            <span>{L_ACP_SIMPLEDOWN_CHOOSE_FILE}</span>
                        </label>
                        <span class="file-name-display" id="thumb-name-display">{L_ACP_SIMPLEDOWN_NO_FILE_SELECTED}</span>
                    </div>
                </dd>
            </dl>
        </fieldset>

        <p class="submit-buttons">
            <input class="button1" type="submit" name="submit_edit" value="{L_ACP_SIMPLEDOWN_SAVE_CHANGES}" />
            <a href="{U_ACTION}" class="button2">{L_ACP_SIMPLEDOWN_CANCEL}</a>
        </p>
    </fieldset>
    <!-- ENDIF -->

    <!-- ======================================== -->
    <!-- LISTAGEM DE ARQUIVOS -->
    <!-- ======================================== -->
    <fieldset>
        <legend>{L_ACP_SIMPLEDOWN_EXISTING_FILES}</legend>

        <div class="acp-controls-top">
            <div class="control-item total-item">
                {L_ACP_SIMPLEDOWN_TOTAL_FILES}: <strong>{TOTAL_FILES}</strong>
            </div>
        </div>

        <!-- IF .files -->
        <table class="table1 compact-table">
            <thead>
                <tr>
                    <th>{L_ACP_SIMPLEDOWN_FILE_NAME}</th>
                    <th>{L_ACP_SIMPLEDOWN_VERSION}</th>
                    <th>{L_ACP_SIMPLEDOWN_VISIBILITY}</th>
                    <th>{L_ACP_SIMPLEDOWN_CATEGORY}</th>
                    <th>{L_ACP_SIMPLEDOWN_DOWNLOADS} / {L_ACP_SIMPLEDOWN_SIZE}</th>
                    <th>{L_ACP_SIMPLEDOWN_ACTIONS}</th>
                </tr>
            </thead>
            <tbody>
                <!-- BEGIN files -->
                <tr>
                    <td>
                        <strong>{files.NAME}</strong><br />
                        <span class="desc-short">
                            {files.DESC_SHORT}
                            <!-- IF files.DESC_FORMATTED -->
                            <span class="view-full-desc"
                                  data-desc="{files.DESC_FORMATTED_ESCAPED}"
                                  title="{L_ACP_SIMPLEDOWN_VIEW_FULL_DESC}"
                                  aria-label="{L_ACP_SIMPLEDOWN_VIEW_FULL_DESC}">
                                <i class="fa-solid fa-eye fa-fw"></i>
                            </span>
                            <!-- ENDIF -->
                        </span><br />
                        <small><i class="icon fa-fw {files.FILE_ICON}"></i> {files.REAL_NAME}</small>
                    </td>
                    <td>{files.VERSION}</td>
                    <td style="text-align: center;">
                        <!-- IF files.IS_PRIVATE -->
                        <i class="fas fa-lock" style="color: #e74c3c;" title="{L_ACP_SIMPLEDOWN_PRIVATE}" aria-hidden="true"></i>
                        <span class="sr-only">{L_ACP_SIMPLEDOWN_PRIVATE}</span>
                        <!-- ELSE -->
                        <i class="fas fa-globe" style="color: #27ae60;" title="{L_ACP_SIMPLEDOWN_PUBLIC}" aria-hidden="true"></i>
                        <span class="sr-only">{L_ACP_SIMPLEDOWN_PUBLIC}</span>
                        <!-- ENDIF -->
                    </td>
                    <td>{files.CAT}</td>
                    <td>{files.DOWNLOADS}<br /><small>{files.SIZE}</small></td>
                    <td>
                        <a href="{files.U_EDIT}" class="button2">{L_ACP_SIMPLEDOWN_EDIT}</a>
                        <a href="{files.U_DELETE}" class="button2 danger">{L_ACP_SIMPLEDOWN_DELETE}</a>
                    </td>
                </tr>
                <!-- END files -->
            </tbody>
        </table>
        <!-- ELSE -->
        <p style="text-align:center; color:var(--text-light); font-style:italic;">{L_ACP_SIMPLEDOWN_NO_FILES_YET}</p>
        <!-- ENDIF -->
    </fieldset>
</form>

<!-- ======================================== -->
<!-- MODAIS -->
<!-- ======================================== -->
<div id="message-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
        <span class="close-modal" title="{L_ACP_SIMPLEDOWN_CLOSE}" aria-label="{L_ACP_SIMPLEDOWN_CLOSE}">&times;</span>
        <!-- IF ERROR_MESSAGE or SUCCESS_MESSAGE -->
        <h3 id="modal-title"><!-- IF ERROR_MESSAGE -->{L_ACP_SIMPLEDOWN_ERROR}<!-- ELSE -->{L_ACP_SIMPLEDOWN_SUCCESS}<!-- ENDIF --></h3>
        <p><!-- IF ERROR_MESSAGE -->{ERROR_MESSAGE}<!-- ELSE -->{SUCCESS_MESSAGE}<!-- ENDIF --></p>
        <!-- ENDIF -->
    </div>
</div>

<div id="desc-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="desc-modal-title">
    <div class="modal-content">
        <span class="close-modal" title="{L_ACP_SIMPLEDOWN_CLOSE}" aria-label="{L_ACP_SIMPLEDOWN_CLOSE}">&times;</span>
        <h3 id="desc-modal-title">{L_ACP_SIMPLEDOWN_DESCRIPTION}</h3>
        <div id="full-desc-content"></div>
    </div>
</div>

<!-- ======================================== -->
<!-- SCRIPT UNIFICADO -->
<!-- ======================================== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // BBCode toolbar
    const textarea = document.getElementById('edit_file_desc');
    if (textarea) {
        const insertBBCode = (open, close = '') => {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selected = textarea.value.substring(start, end);
            const replacement = open + selected + close;
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start + open.length;
            textarea.selectionEnd = start + open.length + selected.length;
        };

        document.querySelectorAll('.bbcode-btn[data-tag]').forEach(btn => {
            btn.addEventListener('click', () => {
                let open = '[' + btn.dataset.tag + ']';
                let close = '[/' + btn.dataset.tag + ']';
                if (btn.dataset.tag === 'url') open = '[url=https://]';
                if (btn.dataset.tag === 'list') {
                    open = '[list]\n[*]';
                    close = '\n[/list]';
                }
                insertBBCode(open, close);
            });
        });

        const picker = document.getElementById('color-picker-edit');
        if (picker) {
            picker.addEventListener('change', () => {
                const color = picker.value.toUpperCase();
                insertBBCode('[color=' + color + ']', '[/color]');
            });
        }

        document.querySelectorAll('.size-select').forEach(select => {
            select.addEventListener('change', () => {
                const size = select.value;
                if (size) insertBBCode('[size=' + size + ']', '[/size]');
                select.value = '';
            });
        });
    }

    // Preview de thumbnail com anti-cache temporário
    const thumbSelect = document.getElementById('existing_thumb');
    const previewDiv = document.getElementById('thumb-preview');
    const previewImg = document.getElementById('thumb-preview-img');

    if (thumbSelect && previewDiv && previewImg) {
        const thumbsDir = '{THUMBS_DIR|escape("js")}';

        const updatePreview = () => {
            const val = thumbSelect.value.trim();
            if (val) {
                // === TEMPORÁRIO: Anti-cache para testes do preview de thumbnail ===
                // Remover o "?v=..." quando tudo estiver estável em produção
                previewImg.src = thumbsDir + encodeURIComponent(val) + '?v=20251229';
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
                previewImg.src = '';
            }
        };

        thumbSelect.addEventListener('change', updatePreview);
        if (thumbSelect.value) updatePreview();
    }

    // Nome dos arquivos selecionados
    ['replace_upload', 'thumb_upload'].forEach(id => {
        const input = document.getElementById(id);
        const display = document.getElementById(id === 'replace_upload' ? 'replace-file-name-display' : 'thumb-name-display');
        if (input && display) {
            input.addEventListener('change', e => {
                display.textContent = e.target.files.length ? e.target.files[0].name : '{L_ACP_SIMPLEDOWN_NO_FILE_SELECTED}';
            });
        }
    });

    // Modal de descrição completa
    document.querySelector('.compact-table')?.addEventListener('click', e => {
        const trigger = e.target.closest('.view-full-desc');
        if (trigger) {
            const desc = trigger.dataset.desc;
            const content = document.getElementById('full-desc-content');
            const modal = document.getElementById('desc-modal');
            if (content && modal && desc) {
                content.innerHTML = desc;
                modal.style.display = 'flex';
            }
        }
    });

    // Fechar modais
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.modal').style.display = 'none';
        });
    });

    window.addEventListener('click', e => {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });

    // Mostrar modal de mensagem se houver
    if ('{ERROR_MESSAGE}' || '{SUCCESS_MESSAGE}') {
        document.getElementById('message-modal').style.display = 'flex';
    }
});
</script>

<!-- INCLUDECSS @mundophpbb_simpledown/acp_simpledown.css -->
<!-- INCLUDE overall_footer.html -->
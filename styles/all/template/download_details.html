<!-- INCLUDE overall_header.html -->
<!-- ======================================== -->
<!-- INCLUSÃO CONDICIONAL DO TEMA CLARO/ESCURO -->
<!-- ======================================== -->
<!-- IF S_SIMPLEDOWN_THEME == 'dark' -->
    <!-- INCLUDECSS @mundophpbb_simpledown/simpledown_dark.css -->
<!-- ELSE -->
    <!-- INCLUDECSS @mundophpbb_simpledown/simpledown_light.css -->
<!-- ENDIF -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400;500;600;700&display=swap" rel="stylesheet">
<div class="simpledown-container">
    <div class="simpledown-header-panel">
        <h2 class="file-name-uppercase">{FILE_NAME}</h2>
        <p class="category-breadcrumb">
            {L_SIMPLEDOWN_CATEGORY}: <strong><em>{CAT_NAME}</em></strong>
        </p>
    </div>
    <div class="details-card-expanded">
        <div class="card-content details-card-content">
            <div class="details-wrapper">
                <!-- IF HAS_THUMBNAIL -->
                <div class="details-thumbnail">
                    <img src="{U_THUMBNAIL}?v={@time()}"
                         alt="{FILE_NAME}"
                         class="thumbnail-fixed"
                         onclick="openImageModal('{U_PREVIEW_ROUTE}')"
                         style="cursor: pointer;" />
                </div>
                <!-- ENDIF -->
                <div class="details-description <!-- IF not HAS_THUMBNAIL -->full-width<!-- ENDIF -->">
                    <!-- IF FILE_DESC -->
                    <p class="file-description-full">{FILE_DESC}</p>
                    <!-- ELSE -->
                    <p class="file-description-full no-description">{L_SIMPLEDOWN_NO_DESCRIPTION}</p>
                    <!-- ENDIF -->
                </div>
            </div>
            <div class="details-single-info-row">
                <span class="details-file-name">
                    <i class="icon fa-fw {FILE_ICON}"></i>
                    <span class="file-realname-truncate">{FILE_REALNAME}</span>
                </span>
                <span class="info-downloads">
                    <i class="icon fa-download fa-fw"></i> {FILE_DOWNLOADS} {L_SIMPLEDOWN_DOWNLOADS_LOWER}
                </span>
                <span class="info-size">
                    <i class="icon fa-hdd-o fa-fw"></i> {FILE_SIZE}
                </span>
                <span class="info-version">
                    <i class="icon fa-tag fa-fw version-icon"></i> {L_SIMPLEDOWN_VERSION}: {VERSION_DISPLAY}
                </span>
                <!-- Indicador de arquivo privado -->
                <!-- IF IS_PRIVATE -->
                <span class="private-badge" title="{L_SIMPLEDOWN_PRIVATE_FILE}">
                    <i class="icon fas fa-lock fa-fw"></i> {L_SIMPLEDOWN_PRIVATE_FILE}
                </span>
                <!-- ENDIF -->
                <!-- Preview de imagem -->
                <!-- IF IS_IMAGE -->
                <span class="preview-btn"
                      onclick="openImageModal('{U_PREVIEW_ROUTE}')"
                      title="{L_SIMPLEDOWN_PREVIEW_IMAGE}"
                      style="cursor: pointer;">
                    <i class="icon fa-eye fa-fw"></i>
                </span>
                <!-- ENDIF -->
            </div>
        </div>
        <div class="card-footer details-card-footer">
            <!-- BOTÃO DE DOWNLOAD ATUALIZADO (usa U_LOG_DENIED) -->
            <a href="javascript:void(0)"
               class="download-btn"
               data-private="{IS_PRIVATE}"
               data-file-id="{FILE_ID}"
               data-download-url="{U_DOWNLOAD_URL}"
               data-denied-url="{U_LOG_DENIED}"
               onclick="handleDownloadClick(this)">
                <i class="icon fa-download fa-fw"></i> {L_DOWNLOAD_BUTTON}
            </a>
        </div>
    </div>
    <div class="back-link">
        <a href="{U_SIMPLEDOWN}">{L_SIMPLEDOWN_BACK_TO_DOWNLOADS}</a>
    </div>
</div>
<!-- Modal para preview de imagem -->
<div id="image-modal" class="image-modal">
    <div class="modal-image-wrapper">
        <span class="modal-close" onclick="closeImageModal()"><i class="icon fas fa-times fa-fw"></i></span>
        <img id="modal-image" class="modal-image-content" alt="{L_SIMPLEDOWN_IMAGE_PREVIEW_ALT}" />
    </div>
</div>
<!-- Modal de login para arquivos privados -->
<div id="login-required-modal" class="image-modal" style="display: none;">
    <div class="modal-image-wrapper private-modal-content">
        <span class="modal-close" onclick="document.getElementById('login-required-modal').style.display='none'">
            <i class="icon fas fa-times fa-fw"></i>
        </span>
        <i class="icon fas fa-lock fa-4x" style="color: #e74c3c; margin-bottom: 20px;"></i>
        <h3>{L_SIMPLEDOWN_LOGIN_REQUIRED}</h3>
        <p>{L_SIMPLEDOWN_PRIVATE_MODAL_TEXT}</p>
        <div>
            <a href="{U_LOGIN}" class="download-btn">
                <i class="icon fas fa-sign-in-alt fa-fw"></i> {L_SIMPLEDOWN_LOGIN_BUTTON}
            </a>
            <a href="{U_REGISTER}" class="details-btn-small">
                <i class="icon fas fa-user-plus fa-fw"></i> {L_SIMPLEDOWN_REGISTER_BUTTON}
            </a>
        </div>
    </div>
</div>
<!-- ======================================== -->
<!-- SCRIPT PRINCIPAL (consistente com a página index) -->
<!-- ======================================== -->
<script>
    const SIMPLE_DOWN_IS_LOGGED_IN = <!-- IF S_IS_LOGGED_IN -->true<!-- ELSE -->false<!-- ENDIF -->;

    function handleDownloadClick(element) {
        const isPrivate = element.getAttribute('data-private') === '1';
        const downloadUrl = element.getAttribute('data-download-url');
        const deniedUrl = element.getAttribute('data-denied-url');

        if (isPrivate && !SIMPLE_DOWN_IS_LOGGED_IN) {
            // Abre o modal de login
            document.getElementById('login-required-modal').style.display = 'flex';

            // Registra acesso negado via AJAX (silencioso)
            if (deniedUrl) {
                fetch(deniedUrl, {
                    method: 'GET',
                    credentials: 'same-origin',
                    cache: 'no-cache'
                })
                .then(() => {})
                .catch(() => {});
            }
            return;
        }

        // Download direto (público ou usuário logado)
        window.location.href = downloadUrl;
    }

    function openImageModal(src) {
        const modalImage = document.getElementById('modal-image');
        modalImage.src = src + (src.indexOf('?') === -1 ? '?t=' : '&t=') + Date.now();
        document.getElementById('image-modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        document.getElementById('image-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Fechar modais ao clicar no fundo
    window.addEventListener('click', function(e) {
        if (e.target.id === 'image-modal') {
            closeImageModal();
        }
        if (e.target.id === 'login-required-modal') {
            e.target.style.display = 'none';
        }
    });
</script>
<!-- INCLUDE overall_footer.html -->